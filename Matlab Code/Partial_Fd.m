function [PartialFd] = Partial_Fd()
Rc1 = 10; Rc2 = 21; Rc3 = 31;
Vc1 = -3; Vc2 = -1.5; Vc3 = 1.1;
sig1 = .2; sig2 = .1; sig3 = .5;
rSun = 10*rand(3,1);
BMatrix = rand(3);
rDeputy = 5*rand(3,1);
rSunDeputy = 2*rand(3,1);
n3Vec = rand(3,1);
C1 = 0.1; C2 = 0.3; C3 = 0.6;
rho1 = 1.1; rho2 = 2.1; rho3 = 2.3;
omegaCh1 = 1; omegaCh2 = .3; omegaCh3 = .5;
omegaChdot1 = 1.1; omegaChdot2 = 1.6; omegaChdot3 = 2.3;
omg1 = 2.1; omg2 = 1.2; omg3 = 3.5; 
muEarth = 1000;
PD = 100;
Acc = rand(3,1);
i1 = 1; i2 = 2; i3 = 3;


%% % Partial of the SRP froce on the deputy plate (as seen in chief LVLH frame)
% ------------------------------------------------------------------------
pCb1pSigma = [8.*(Rc1.^2+Rc2.^2+Rc3.^2).^(-1/2).*(1+sig1.^2+sig2.^2+ ...
  sig3.^2).^(-3).*(4.*Rc1.*sig1.*(sig2.^2+sig3.^2)+Rc2.*(sig2.^3+ ...
  sig1.*sig2.^2.*sig3+sig2.*(1+(-3).*sig1.^2+sig3.^2)+sig1.*sig3.*(( ...
  -3)+sig1.^2+sig3.^2))+Rc3.*((-1).*sig1.^3.*sig2+(-3).*sig1.^2.* ...
  sig3+(-1).*sig1.*sig2.*((-3)+sig2.^2+sig3.^2)+sig3.*(1+sig2.^2+ ...
  sig3.^2))),4.*(Rc1.^2+Rc2.^2+Rc3.^2).^(-1/2).*(1+sig1.^2+sig2.^2+ ...
  sig3.^2).^(-3).*(4.*Rc1.*sig2.*((-1)+(-1).*sig1.^2+sig2.^2+ ...
  sig3.^2)+2.*Rc2.*(sig1+sig1.^3+(-3).*sig1.*sig2.^2+sig2.*((-3)+ ...
  sig1.^2+sig2.^2).*sig3+sig1.*sig3.^2+sig2.*sig3.^3)+Rc3.*((-1)+ ...
  sig1.^4+6.*sig2.^2+(-1).*sig2.^4+(-8).*sig1.*sig2.*sig3+2.* ...
  sig1.^2.*sig3.^2+sig3.^4)),(Rc1.^2+Rc2.^2+Rc3.^2).^(-1/2).*(1+ ...
  sig1.^2+sig2.^2+sig3.^2).^(-3).*((-4).*Rc2.*((-1)+(sig1.^2+ ...
  sig2.^2).^2+8.*sig1.*sig2.*sig3+6.*sig3.^2+(-1).*sig3.^4)+8.*(2.* ...
  Rc1.*sig3.*((-1)+(-1).*sig1.^2+sig2.^2+sig3.^2)+Rc3.*(sig1.*(1+ ...
  sig1.^2+sig2.^2)+(-1).*sig2.*((-3)+sig1.^2+sig2.^2).*sig3+(-3).* ...
  sig1.*sig3.^2+(-1).*sig2.*sig3.^3)));4.*(Rc1.^2+Rc2.^2+Rc3.^2).^( ...
  -1/2).*(1+sig1.^2+sig2.^2+sig3.^2).^(-3).*(4.*Rc2.*sig1.*((-1)+ ...
  sig1.^2+(-1).*sig2.^2+sig3.^2)+2.*Rc1.*(sig2+(-3).*sig1.^2.*sig2+ ...
  sig2.^3+(-1).*sig1.*((-3)+sig1.^2+sig2.^2).*sig3+sig2.*sig3.^2+( ...
  -1).*sig1.*sig3.^3)+Rc3.*((-1)+6.*sig1.^2+(-1).*sig1.^4+(-8).* ...
  sig1.*sig2.*sig3+(sig2.^2+sig3.^2).^2)),8.*(Rc1.^2+Rc2.^2+Rc3.^2) ...
  .^(-1/2).*(1+sig1.^2+sig2.^2+sig3.^2).^(-3).*(4.*Rc2.*sig2.*( ...
  sig1.^2+sig3.^2)+Rc1.*(sig1+sig1.^3+(-3).*sig1.*sig2.^2+(-1).* ...
  sig2.*((-3)+sig1.^2+sig2.^2).*sig3+sig1.*sig3.^2+(-1).*sig2.* ...
  sig3.^3)+Rc3.*((-1).*sig1.^3.*sig2+sig3+sig1.^2.*sig3+(-3).* ...
  sig2.^2.*sig3+sig3.^3+(-1).*sig1.*sig2.*((-3)+sig2.^2+sig3.^2))),( ...
  Rc1.^2+Rc2.^2+Rc3.^2).^(-1/2).*(1+sig1.^2+sig2.^2+sig3.^2).^(-3).* ...
  (4.*Rc1.*((-1)+(sig1.^2+sig2.^2).^2+(-8).*sig1.*sig2.*sig3+6.* ...
  sig3.^2+(-1).*sig3.^4)+8.*(2.*Rc2.*sig3.*((-1)+sig1.^2+(-1).* ...
  sig2.^2+sig3.^2)+Rc3.*(sig2.*(1+sig1.^2+sig2.^2)+(-1).*sig1.*((-3) ...
  +sig1.^2+sig2.^2).*sig3+(-3).*sig2.*sig3.^2+(-1).*sig1.*sig3.^3))) ...
  ;4.*(Rc1.^2+Rc2.^2+Rc3.^2).^(-1/2).*(1+sig1.^2+sig2.^2+sig3.^2).^( ...
  -3).*(4.*Rc3.*sig1.*((-1)+sig1.^2+sig2.^2+(-1).*sig3.^2)+Rc2.*(( ...
  -1)+6.*sig1.^2+(-1).*sig1.^4+(-8).*sig1.*sig2.*sig3+(sig2.^2+ ...
  sig3.^2).^2)+2.*Rc1.*(sig1.^3.*sig2+(-3).*sig1.^2.*sig3+sig1.* ...
  sig2.*((-3)+sig2.^2+sig3.^2)+sig3.*(1+sig2.^2+sig3.^2))),(Rc1.^2+ ...
  Rc2.^2+Rc3.^2).^(-1/2).*(1+sig1.^2+sig2.^2+sig3.^2).^(-3).*(16.* ...
  Rc3.*sig2.*((-1)+sig1.^2+sig2.^2+(-1).*sig3.^2)+(-4).*Rc1.*((-1)+ ...
  sig1.^4+6.*sig2.^2+(-1).*sig2.^4+8.*sig1.*sig2.*sig3+2.*sig1.^2.* ...
  sig3.^2+sig3.^4)+8.*Rc2.*((-1).*sig1.^3.*sig2+sig3+sig1.^2.*sig3+( ...
  -3).*sig2.^2.*sig3+sig3.^3+(-1).*sig1.*sig2.*((-3)+sig2.^2+ ...
  sig3.^2))),8.*(Rc1.^2+Rc2.^2+Rc3.^2).^(-1/2).*(1+sig1.^2+sig2.^2+ ...
  sig3.^2).^(-3).*((Rc1.*sig1+Rc2.*sig2).*(1+sig1.^2+sig2.^2)+((-3) ...
  .*Rc1.*sig2+(-1).*Rc2.*sig1.*((-3)+sig1.^2+sig2.^2)+(4.*Rc3+Rc1.* ...
  sig2).*(sig1.^2+sig2.^2)).*sig3+(-3).*(Rc1.*sig1+Rc2.*sig2).* ...
  sig3.^2+((-1).*Rc2.*sig1+Rc1.*sig2).*sig3.^3)];

pCb1pXstate = [pCb1pSigma, zeros(3,9)];

% ------------------------------------------------------------------------
pCb2pSigma = [8.*(Rc1.^2+Rc2.^2+Rc3.^2).^(-1/2).*(1+sig1.^2+sig2.^2+ ...
  sig3.^2).^(-3).*((Rc2.*Vc1+(-1).*Rc1.*Vc2).^2+(Rc3.*Vc1+(-1).* ...
  Rc1.*Vc3).^2+(Rc3.*Vc2+(-1).*Rc2.*Vc3).^2).^(-1/2).*(Rc3.^2.*(4.* ...
  sig1.*(sig2.^2+sig3.^2).*Vc1+(sig2+(-3).*sig1.^2.*sig2+sig2.^3+ ...
  sig1.*((-3)+sig1.^2+sig2.^2).*sig3+sig2.*sig3.^2+sig1.*sig3.^3).* ...
  Vc2)+(-1).*Rc1.*(Rc2.*(sig2+(-3).*sig1.^2.*sig2+sig2.^3+sig1.*(( ...
  -3)+sig1.^2+sig2.^2).*sig3+sig2.*sig3.^2+sig1.*sig3.^3).*Vc1+Rc3.* ...
  ((-1).*sig1.^3.*sig2+(-3).*sig1.^2.*sig3+(-1).*sig1.*sig2.*((-3)+ ...
  sig2.^2+sig3.^2)+sig3.*(1+sig2.^2+sig3.^2)).*Vc1+4.*Rc2.*sig1.*( ...
  sig2.^2+sig3.^2).*Vc2+4.*Rc3.*sig1.*(sig2.^2+sig3.^2).*Vc3)+ ...
  Rc2.^2.*(4.*sig1.*(sig2.^2+sig3.^2).*Vc1+((-1).*sig1.^3.*sig2+(-3) ...
  .*sig1.^2.*sig3+(-1).*sig1.*sig2.*((-3)+sig2.^2+sig3.^2)+sig3.*(1+ ...
  sig2.^2+sig3.^2)).*Vc3)+Rc1.^2.*((sig2+(-3).*sig1.^2.*sig2+ ...
  sig2.^3+sig1.*((-3)+sig1.^2+sig2.^2).*sig3+sig2.*sig3.^2+sig1.* ...
  sig3.^3).*Vc2+((-1).*sig1.^3.*sig2+(-3).*sig1.^2.*sig3+(-1).* ...
  sig1.*sig2.*((-3)+sig2.^2+sig3.^2)+sig3.*(1+sig2.^2+sig3.^2)).* ...
  Vc3)+Rc2.*Rc3.*(3.*sig1.^2.*(sig3.*Vc2+sig2.*Vc3)+(-1).*(1+ ...
  sig2.^2+sig3.^2).*(sig3.*Vc2+sig2.*Vc3)+sig1.^3.*(sig2.*Vc2+(-1).* ...
  sig3.*Vc3)+sig1.*((-3)+sig2.^2+sig3.^2).*(sig2.*Vc2+(-1).*sig3.* ...
  Vc3))),4.*(Rc1.^2+Rc2.^2+Rc3.^2).^(-1/2).*(1+sig1.^2+sig2.^2+ ...
  sig3.^2).^(-3).*((Rc2.*Vc1+(-1).*Rc1.*Vc2).^2+(Rc3.*Vc1+(-1).* ...
  Rc1.*Vc3).^2+(Rc3.*Vc2+(-1).*Rc2.*Vc3).^2).^(-1/2).*(2.*Rc3.^2.*( ...
  2.*sig2.*((-1)+(-1).*sig1.^2+sig2.^2+sig3.^2).*Vc1+(sig1+sig1.^3+( ...
  -3).*sig1.*sig2.^2+sig2.*((-3)+sig1.^2+sig2.^2).*sig3+sig1.* ...
  sig3.^2+sig2.*sig3.^3).*Vc2)+(-1).*Rc1.*(2.*Rc2.*(sig1+sig1.^3+( ...
  -3).*sig1.*sig2.^2+sig2.*((-3)+sig1.^2+sig2.^2).*sig3+sig1.* ...
  sig3.^2+sig2.*sig3.^3).*Vc1+Rc3.*((-1)+sig1.^4+6.*sig2.^2+(-1).* ...
  sig2.^4+(-8).*sig1.*sig2.*sig3+2.*sig1.^2.*sig3.^2+sig3.^4).*Vc1+ ...
  4.*Rc2.*sig2.*((-1)+(-1).*sig1.^2+sig2.^2+sig3.^2).*Vc2+4.*Rc3.* ...
  sig2.*((-1)+(-1).*sig1.^2+sig2.^2+sig3.^2).*Vc3)+Rc2.*Rc3.*((-1).* ...
  ((-1)+sig1.^4+6.*sig2.^2+(-1).*sig2.^4+(-8).*sig1.*sig2.*sig3+2.* ...
  sig1.^2.*sig3.^2+sig3.^4).*Vc2+(-2).*(sig1+sig1.^3+(-3).*sig1.* ...
  sig2.^2+sig2.*((-3)+sig1.^2+sig2.^2).*sig3+sig1.*sig3.^2+sig2.* ...
  sig3.^3).*Vc3)+Rc2.^2.*(4.*sig2.*((-1)+(-1).*sig1.^2+sig2.^2+ ...
  sig3.^2).*Vc1+((-1)+sig1.^4+6.*sig2.^2+(-1).*sig2.^4+(-8).*sig1.* ...
  sig2.*sig3+2.*sig1.^2.*sig3.^2+sig3.^4).*Vc3)+Rc1.^2.*(2.*(sig1+ ...
  sig1.^3+(-3).*sig1.*sig2.^2+sig2.*((-3)+sig1.^2+sig2.^2).*sig3+ ...
  sig1.*sig3.^2+sig2.*sig3.^3).*Vc2+((-1)+sig1.^4+6.*sig2.^2+(-1).* ...
  sig2.^4+(-8).*sig1.*sig2.*sig3+2.*sig1.^2.*sig3.^2+sig3.^4).*Vc3)) ...
  ,(-4).*(Rc1.^2+Rc2.^2+Rc3.^2).^(-1/2).*(1+sig1.^2+sig2.^2+sig3.^2) ...
  .^(-3).*((Rc2.*Vc1+(-1).*Rc1.*Vc2).^2+(Rc3.*Vc1+(-1).*Rc1.*Vc3) ...
  .^2+(Rc3.*Vc2+(-1).*Rc2.*Vc3).^2).^(-1/2).*(Rc3.^2.*((-4).*sig3.*( ...
  (-1)+(-1).*sig1.^2+sig2.^2+sig3.^2).*Vc1+((-1)+(sig1.^2+sig2.^2) ...
  .^2+8.*sig1.*sig2.*sig3+6.*sig3.^2+(-1).*sig3.^4).*Vc2)+Rc1.*(2.* ...
  Rc3.*(sig1.*(1+sig1.^2+sig2.^2)+(-1).*sig2.*((-3)+sig1.^2+sig2.^2) ...
  .*sig3+(-3).*sig1.*sig3.^2+(-1).*sig2.*sig3.^3).*Vc1+(-1).*Rc2.*(( ...
  -1)+(sig1.^2+sig2.^2).^2+8.*sig1.*sig2.*sig3+6.*sig3.^2+(-1).* ...
  sig3.^4).*Vc1+4.*Rc2.*sig3.*((-1)+(-1).*sig1.^2+sig2.^2+sig3.^2).* ...
  Vc2+4.*Rc3.*sig3.*((-1)+(-1).*sig1.^2+sig2.^2+sig3.^2).*Vc3)+2.* ...
  Rc2.^2.*((-2).*sig3.*((-1)+(-1).*sig1.^2+sig2.^2+sig3.^2).*Vc1+(( ...
  -1).*sig1.*(1+sig1.^2+sig2.^2)+sig2.*((-3)+sig1.^2+sig2.^2).*sig3+ ...
  3.*sig1.*sig3.^2+sig2.*sig3.^3).*Vc3)+Rc1.^2.*(((-1)+(sig1.^2+ ...
  sig2.^2).^2+8.*sig1.*sig2.*sig3+6.*sig3.^2+(-1).*sig3.^4).*Vc2+2.* ...
  ((-1).*sig1.*(1+sig1.^2+sig2.^2)+sig2.*((-3)+sig1.^2+sig2.^2).* ...
  sig3+3.*sig1.*sig3.^2+sig2.*sig3.^3).*Vc3)+Rc2.*Rc3.*(2.*(sig1.*( ...
  1+sig1.^2+sig2.^2)+(-1).*sig2.*((-3)+sig1.^2+sig2.^2).*sig3+(-3).* ...
  sig1.*sig3.^2+(-1).*sig2.*sig3.^3).*Vc2+Vc3+(-1).*((sig1.^2+ ...
  sig2.^2).^2+8.*sig1.*sig2.*sig3+6.*sig3.^2+(-1).*sig3.^4).*Vc3)); ...
  4.*(Rc1.^2+Rc2.^2+Rc3.^2).^(-1/2).*(1+sig1.^2+sig2.^2+sig3.^2).^( ...
  -3).*((Rc2.*Vc1+(-1).*Rc1.*Vc2).^2+(Rc3.*Vc1+(-1).*Rc1.*Vc3).^2+( ...
  Rc3.*Vc2+(-1).*Rc2.*Vc3).^2).^(-1/2).*(2.*Rc3.^2.*((sig2+(-3).* ...
  sig1.^2.*sig2+sig2.^3+(-1).*sig1.*((-3)+sig1.^2+sig2.^2).*sig3+ ...
  sig2.*sig3.^2+(-1).*sig1.*sig3.^3).*Vc1+2.*sig1.*((-1)+sig1.^2+( ...
  -1).*sig2.^2+sig3.^2).*Vc2)+Rc2.*Rc3.*(((-6).*sig1.^2+sig1.^4+8.* ...
  sig1.*sig2.*sig3+(-1).*((-1)+sig2.^2+sig3.^2).*(1+sig2.^2+sig3.^2) ...
  ).*Vc2+(-4).*sig1.*((-1)+sig1.^2+(-1).*sig2.^2+sig3.^2).*Vc3)+ ...
  Rc1.*((-4).*Rc2.*sig1.*((-1)+sig1.^2+(-1).*sig2.^2+sig3.^2).*Vc1+ ...
  Rc3.*((-6).*sig1.^2+sig1.^4+8.*sig1.*sig2.*sig3+(-1).*((-1)+ ...
  sig2.^2+sig3.^2).*(1+sig2.^2+sig3.^2)).*Vc1+(-2).*Rc2.*(sig2+(-3) ...
  .*sig1.^2.*sig2+sig2.^3+(-1).*sig1.*((-3)+sig1.^2+sig2.^2).*sig3+ ...
  sig2.*sig3.^2+(-1).*sig1.*sig3.^3).*Vc2+(-2).*Rc3.*(sig2+(-3).* ...
  sig1.^2.*sig2+sig2.^3+(-1).*sig1.*((-3)+sig1.^2+sig2.^2).*sig3+ ...
  sig2.*sig3.^2+(-1).*sig1.*sig3.^3).*Vc3)+Rc2.^2.*(2.*(sig2+(-3).* ...
  sig1.^2.*sig2+sig2.^3+(-1).*sig1.*((-3)+sig1.^2+sig2.^2).*sig3+ ...
  sig2.*sig3.^2+(-1).*sig1.*sig3.^3).*Vc1+((-1)+6.*sig1.^2+(-1).* ...
  sig1.^4+(-8).*sig1.*sig2.*sig3+(sig2.^2+sig3.^2).^2).*Vc3)+ ...
  Rc1.^2.*(4.*sig1.*((-1)+sig1.^2+(-1).*sig2.^2+sig3.^2).*Vc2+((-1)+ ...
  6.*sig1.^2+(-1).*sig1.^4+(-8).*sig1.*sig2.*sig3+(sig2.^2+sig3.^2) ...
  .^2).*Vc3)),8.*(Rc1.^2+Rc2.^2+Rc3.^2).^(-1/2).*(1+sig1.^2+sig2.^2+ ...
  sig3.^2).^(-3).*((Rc2.*Vc1+(-1).*Rc1.*Vc2).^2+(Rc3.*Vc1+(-1).* ...
  Rc1.*Vc3).^2+(Rc3.*Vc2+(-1).*Rc2.*Vc3).^2).^(-1/2).*(Rc3.^2.*(( ...
  sig1+sig1.^3+(-3).*sig1.*sig2.^2+(-1).*sig2.*((-3)+sig1.^2+ ...
  sig2.^2).*sig3+sig1.*sig3.^2+(-1).*sig2.*sig3.^3).*Vc1+4.*sig2.*( ...
  sig1.^2+sig3.^2).*Vc2)+(-1).*Rc2.*(4.*Rc1.*sig2.*(sig1.^2+sig3.^2) ...
  .*Vc1+Rc1.*(sig1+sig1.^3+(-3).*sig1.*sig2.^2+(-1).*sig2.*((-3)+ ...
  sig1.^2+sig2.^2).*sig3+sig1.*sig3.^2+(-1).*sig2.*sig3.^3).*Vc2+ ...
  Rc3.*((-1).*sig1.^3.*sig2+sig3+sig1.^2.*sig3+(-3).*sig2.^2.*sig3+ ...
  sig3.^3+(-1).*sig1.*sig2.*((-3)+sig2.^2+sig3.^2)).*Vc2+4.*Rc3.* ...
  sig2.*(sig1.^2+sig3.^2).*Vc3)+Rc2.^2.*((sig1+sig1.^3+(-3).*sig1.* ...
  sig2.^2+(-1).*sig2.*((-3)+sig1.^2+sig2.^2).*sig3+sig1.*sig3.^2+( ...
  -1).*sig2.*sig3.^3).*Vc1+((-1).*sig1.^3.*sig2+sig3+sig1.^2.*sig3+( ...
  -3).*sig2.^2.*sig3+sig3.^3+(-1).*sig1.*sig2.*((-3)+sig2.^2+ ...
  sig3.^2)).*Vc3)+Rc1.^2.*(4.*sig2.*(sig1.^2+sig3.^2).*Vc2+((-1).* ...
  sig1.^3.*sig2+sig3+sig1.^2.*sig3+(-3).*sig2.^2.*sig3+sig3.^3+(-1) ...
  .*sig1.*sig2.*((-3)+sig2.^2+sig3.^2)).*Vc3)+Rc1.*Rc3.*((-1).* ...
  sig3.*(1+(-3).*sig2.^2+sig3.^2).*Vc1+sig1.*sig2.*((-3)+sig2.^2+ ...
  sig3.^2).*Vc1+sig1.^3.*(sig2.*Vc1+(-1).*Vc3)+sig1.*((-1)+3.* ...
  sig2.^2+(-1).*sig3.^2).*Vc3+sig2.*sig3.*((-3)+sig2.^2+sig3.^2).* ...
  Vc3+sig1.^2.*sig3.*((-1).*Vc1+sig2.*Vc3))),4.*(Rc1.^2+Rc2.^2+ ...
  Rc3.^2).^(-1/2).*(1+sig1.^2+sig2.^2+sig3.^2).^(-3).*((Rc2.*Vc1+( ...
  -1).*Rc1.*Vc2).^2+(Rc3.*Vc1+(-1).*Rc1.*Vc3).^2+(Rc3.*Vc2+(-1).* ...
  Rc2.*Vc3).^2).^(-1/2).*(Rc3.^2.*(((-1)+(sig1.^2+sig2.^2).^2+(-8).* ...
  sig1.*sig2.*sig3+6.*sig3.^2+(-1).*sig3.^4).*Vc1+4.*sig3.*((-1)+ ...
  sig1.^2+(-1).*sig2.^2+sig3.^2).*Vc2)+Rc2.*((-4).*Rc1.*sig3.*((-1)+ ...
  sig1.^2+(-1).*sig2.^2+sig3.^2).*Vc1+(-2).*Rc3.*(sig2.*(1+sig1.^2+ ...
  sig2.^2)+(-1).*sig1.*((-3)+sig1.^2+sig2.^2).*sig3+(-3).*sig2.* ...
  sig3.^2+(-1).*sig1.*sig3.^3).*Vc2+(-1).*Rc1.*((-1)+(sig1.^2+ ...
  sig2.^2).^2+(-8).*sig1.*sig2.*sig3+6.*sig3.^2+(-1).*sig3.^4).*Vc2+ ...
  (-4).*Rc3.*sig3.*((-1)+sig1.^2+(-1).*sig2.^2+sig3.^2).*Vc3)+2.* ...
  Rc1.^2.*(2.*sig3.*((-1)+sig1.^2+(-1).*sig2.^2+sig3.^2).*Vc2+( ...
  sig2.*(1+sig1.^2+sig2.^2)+(-1).*sig1.*((-3)+sig1.^2+sig2.^2).* ...
  sig3+(-3).*sig2.*sig3.^2+(-1).*sig1.*sig3.^3).*Vc3)+Rc2.^2.*(((-1) ...
  +(sig1.^2+sig2.^2).^2+(-8).*sig1.*sig2.*sig3+6.*sig3.^2+(-1).* ...
  sig3.^4).*Vc1+2.*(sig2.*(1+sig1.^2+sig2.^2)+(-1).*sig1.*((-3)+ ...
  sig1.^2+sig2.^2).*sig3+(-3).*sig2.*sig3.^2+(-1).*sig1.*sig3.^3).* ...
  Vc3)+Rc1.*Rc3.*(2.*((-1).*sig2.*(1+sig1.^2+sig2.^2)+sig1.*((-3)+ ...
  sig1.^2+sig2.^2).*sig3+3.*sig2.*sig3.^2+sig1.*sig3.^3).*Vc1+Vc3+( ...
  -1).*((sig1.^2+sig2.^2).^2+(-8).*sig1.*sig2.*sig3+6.*sig3.^2+(-1) ...
  .*sig3.^4).*Vc3));(-4).*(Rc1.^2+Rc2.^2+Rc3.^2).^(-1/2).*(1+ ...
  sig1.^2+sig2.^2+sig3.^2).^(-3).*((Rc2.*Vc1+(-1).*Rc1.*Vc2).^2+( ...
  Rc3.*Vc1+(-1).*Rc1.*Vc3).^2+(Rc3.*Vc2+(-1).*Rc2.*Vc3).^2).^(-1/2) ...
  .*(Rc3.^2.*((-2).*(sig1.^3.*sig2+(-3).*sig1.^2.*sig3+sig1.*sig2.*( ...
  (-3)+sig2.^2+sig3.^2)+sig3.*(1+sig2.^2+sig3.^2)).*Vc1+Vc2+((-6).* ...
  sig1.^2+sig1.^4+8.*sig1.*sig2.*sig3+(-1).*(sig2.^2+sig3.^2).^2).* ...
  Vc2)+Rc1.^2.*(((-6).*sig1.^2+sig1.^4+8.*sig1.*sig2.*sig3+(-1).*(( ...
  -1)+sig2.^2+sig3.^2).*(1+sig2.^2+sig3.^2)).*Vc2+(-4).*sig1.*((-1)+ ...
  sig1.^2+sig2.^2+(-1).*sig3.^2).*Vc3)+2.*Rc2.^2.*((-1).*(sig1.^3.* ...
  sig2+(-3).*sig1.^2.*sig3+sig1.*sig2.*((-3)+sig2.^2+sig3.^2)+sig3.* ...
  (1+sig2.^2+sig3.^2)).*Vc1+(-2).*sig1.*((-1)+sig1.^2+sig2.^2+(-1).* ...
  sig3.^2).*Vc3)+Rc2.*Rc3.*(4.*sig1.*((-1)+sig1.^2+sig2.^2+(-1).* ...
  sig3.^2).*Vc2+((-1)+6.*sig1.^2+(-1).*sig1.^4+(-8).*sig1.*sig2.* ...
  sig3+(sig2.^2+sig3.^2).^2).*Vc3)+Rc1.*(4.*Rc3.*sig1.*((-1)+ ...
  sig1.^2+sig2.^2+(-1).*sig3.^2).*Vc1+Rc2.*((-1)+6.*sig1.^2+(-1).* ...
  sig1.^4+(-8).*sig1.*sig2.*sig3+(sig2.^2+sig3.^2).^2).*Vc1+2.*Rc2.* ...
  (sig1.^3.*sig2+(-3).*sig1.^2.*sig3+sig1.*sig2.*((-3)+sig2.^2+ ...
  sig3.^2)+sig3.*(1+sig2.^2+sig3.^2)).*Vc2+2.*Rc3.*(sig1.^3.*sig2+( ...
  -3).*sig1.^2.*sig3+sig1.*sig2.*((-3)+sig2.^2+sig3.^2)+sig3.*(1+ ...
  sig2.^2+sig3.^2)).*Vc3)),(-4).*(Rc1.^2+Rc2.^2+Rc3.^2).^(-1/2).*(1+ ...
  sig1.^2+sig2.^2+sig3.^2).^(-3).*((Rc2.*Vc1+(-1).*Rc1.*Vc2).^2+( ...
  Rc3.*Vc1+(-1).*Rc1.*Vc3).^2+(Rc3.*Vc2+(-1).*Rc2.*Vc3).^2).^(-1/2) ...
  .*(Rc3.^2.*(((-1)+sig1.^4+6.*sig2.^2+(-1).*sig2.^4+8.*sig1.*sig2.* ...
  sig3+2.*sig1.^2.*sig3.^2+sig3.^4).*Vc1+2.*(sig1.*sig2.*((-3)+ ...
  sig1.^2+sig2.^2)+(-1).*(1+sig1.^2+(-3).*sig2.^2).*sig3+sig1.* ...
  sig2.*sig3.^2+(-1).*sig3.^3).*Vc2)+Rc2.^2.*(((-1)+sig1.^4+6.* ...
  sig2.^2+(-1).*sig2.^4+8.*sig1.*sig2.*sig3+2.*sig1.^2.*sig3.^2+ ...
  sig3.^4).*Vc1+(-4).*sig2.*((-1)+sig1.^2+sig2.^2+(-1).*sig3.^2).* ...
  Vc3)+2.*Rc1.^2.*((sig1.*sig2.*((-3)+sig1.^2+sig2.^2)+(-1).*(1+ ...
  sig1.^2+(-3).*sig2.^2).*sig3+sig1.*sig2.*sig3.^2+(-1).*sig3.^3).* ...
  Vc2+(-2).*sig2.*((-1)+sig1.^2+sig2.^2+(-1).*sig3.^2).*Vc3)+(-1).* ...
  Rc2.*(2.*Rc1.*(sig1.*sig2.*((-3)+sig1.^2+sig2.^2)+(-1).*(1+ ...
  sig1.^2+(-3).*sig2.^2).*sig3+sig1.*sig2.*sig3.^2+(-1).*sig3.^3).* ...
  Vc1+(-4).*Rc3.*sig2.*((-1)+sig1.^2+sig2.^2+(-1).*sig3.^2).*Vc2+ ...
  Rc1.*((-1)+sig1.^4+6.*sig2.^2+(-1).*sig2.^4+8.*sig1.*sig2.*sig3+ ...
  2.*sig1.^2.*sig3.^2+sig3.^4).*Vc2+2.*Rc3.*(sig1.*sig2.*((-3)+ ...
  sig1.^2+sig2.^2)+(-1).*(1+sig1.^2+(-3).*sig2.^2).*sig3+sig1.* ...
  sig2.*sig3.^2+(-1).*sig3.^3).*Vc3)+Rc1.*Rc3.*(4.*sig2.*((-1)+ ...
  sig1.^2+sig2.^2+(-1).*sig3.^2).*Vc1+Vc3+(-1).*(sig1.^4+6.*sig2.^2+ ...
  (-1).*sig2.^4+8.*sig1.*sig2.*sig3+2.*sig1.^2.*sig3.^2+sig3.^4).* ...
  Vc3)),8.*(Rc1.^2+Rc2.^2+Rc3.^2).^(-1/2).*(1+sig1.^2+sig2.^2+ ...
  sig3.^2).^(-3).*((Rc2.*Vc1+(-1).*Rc1.*Vc2).^2+(Rc3.*Vc1+(-1).* ...
  Rc1.*Vc3).^2+(Rc3.*Vc2+(-1).*Rc2.*Vc3).^2).^(-1/2).*(Rc3.^2.*( ...
  sig1.*(1+sig2.^2+(-3).*sig3.^2).*Vc1+sig2.*sig3.*((-3)+sig2.^2+ ...
  sig3.^2).*Vc1+sig2.*(1+sig2.^2+(-3).*sig3.^2).*Vc2+(-1).*sig1.* ...
  sig3.*((-3)+sig2.^2+sig3.^2).*Vc2+sig1.^2.*sig2.*(sig3.*Vc1+Vc2)+ ...
  sig1.^3.*(Vc1+(-1).*sig3.*Vc2))+Rc2.^2.*((sig1.^3+sig1.^2.*sig2.* ...
  sig3+sig1.*(1+sig2.^2+(-3).*sig3.^2)+sig2.*sig3.*((-3)+sig2.^2+ ...
  sig3.^2)).*Vc1+4.*(sig1.^2+sig2.^2).*sig3.*Vc3)+Rc1.^2.*((sig2.^3+ ...
  (-1).*sig1.*sig2.^2.*sig3+sig2.*(1+sig1.^2+(-3).*sig3.^2)+(-1).* ...
  sig1.*sig3.*((-3)+sig1.^2+sig3.^2)).*Vc2+4.*(sig1.^2+sig2.^2).* ...
  sig3.*Vc3)+(-1).*Rc2.*(Rc1.*(sig2.*(1+sig1.^2+sig2.^2)+(-1).* ...
  sig1.*((-3)+sig1.^2+sig2.^2).*sig3+(-3).*sig2.*sig3.^2+(-1).* ...
  sig1.*sig3.^3).*Vc1+4.*Rc3.*(sig1.^2+sig2.^2).*sig3.*Vc2+Rc1.*( ...
  sig1.*(1+sig1.^2+sig2.^2)+sig2.*((-3)+sig1.^2+sig2.^2).*sig3+(-3) ...
  .*sig1.*sig3.^2+sig2.*sig3.^3).*Vc2+Rc3.*(sig2.*(1+sig1.^2+ ...
  sig2.^2)+(-1).*sig1.*((-3)+sig1.^2+sig2.^2).*sig3+(-3).*sig2.* ...
  sig3.^2+(-1).*sig1.*sig3.^3).*Vc3)+Rc1.*Rc3.*((-4).*(sig1.^2+ ...
  sig2.^2).*sig3.*Vc1+(-1).*(sig1.^3+sig1.^2.*sig2.*sig3+sig1.*(1+ ...
  sig2.^2+(-3).*sig3.^2)+sig2.*sig3.*((-3)+sig2.^2+sig3.^2)).*Vc3)) ...
  ];

pCb2pXstate = [pCb2pSigma, zeros(3,9)];

% ------------------------------------------------------------------------
pCb3pSigma = [8.*(1+sig1.^2+sig2.^2+sig3.^2).^(-3).*(Rc3.*(sig2+(-3) ...
  .*sig1.^2.*sig2+sig2.^3+sig1.*((-3)+sig1.^2+sig2.^2).*sig3+sig2.* ...
  sig3.^2+sig1.*sig3.^3).*Vc1+(-4).*Rc3.*sig1.*(sig2.^2+sig3.^2).* ...
  Vc2+(sig1.^3.*sig2+3.*sig1.^2.*sig3+sig1.*sig2.*((-3)+sig2.^2+ ...
  sig3.^2)+(-1).*sig3.*(1+sig2.^2+sig3.^2)).*(Rc2.*Vc1+(-1).*Rc1.* ...
  Vc2)+4.*Rc2.*sig1.*(sig2.^2+sig3.^2).*Vc3+(-1).*Rc1.*(sig2+(-3).* ...
  sig1.^2.*sig2+sig2.^3+sig1.*((-3)+sig1.^2+sig2.^2).*sig3+sig2.* ...
  sig3.^2+sig1.*sig3.^3).*Vc3).*((Rc2.*Vc1+(-1).*Rc1.*Vc2).^2+(Rc3.* ...
  Vc1+(-1).*Rc1.*Vc3).^2+(Rc3.*Vc2+(-1).*Rc2.*Vc3).^2).^(-1/2),4.*( ...
  1+sig1.^2+sig2.^2+sig3.^2).^(-3).*(2.*Rc3.*(sig1+sig1.^3+(-3).* ...
  sig1.*sig2.^2+sig2.*((-3)+sig1.^2+sig2.^2).*sig3+sig1.*sig3.^2+ ...
  sig2.*sig3.^3).*Vc1+(-1).*Rc2.*((-1)+sig1.^4+6.*sig2.^2+(-1).* ...
  sig2.^4+(-8).*sig1.*sig2.*sig3+2.*sig1.^2.*sig3.^2+sig3.^4).*Vc1+( ...
  -4).*Rc3.*sig2.*((-1)+(-1).*sig1.^2+sig2.^2+sig3.^2).*Vc2+Rc1.*(( ...
  -1)+sig1.^4+6.*sig2.^2+(-1).*sig2.^4+(-8).*sig1.*sig2.*sig3+2.* ...
  sig1.^2.*sig3.^2+sig3.^4).*Vc2+4.*Rc2.*sig2.*((-1)+(-1).*sig1.^2+ ...
  sig2.^2+sig3.^2).*Vc3+(-2).*Rc1.*(sig1+sig1.^3+(-3).*sig1.* ...
  sig2.^2+sig2.*((-3)+sig1.^2+sig2.^2).*sig3+sig1.*sig3.^2+sig2.* ...
  sig3.^3).*Vc3).*((Rc2.*Vc1+(-1).*Rc1.*Vc2).^2+(Rc3.*Vc1+(-1).* ...
  Rc1.*Vc3).^2+(Rc3.*Vc2+(-1).*Rc2.*Vc3).^2).^(-1/2),4.*(1+sig1.^2+ ...
  sig2.^2+sig3.^2).^(-3).*((-1).*Rc3.*((-1)+(sig1.^2+sig2.^2).^2+8.* ...
  sig1.*sig2.*sig3+6.*sig3.^2+(-1).*sig3.^4).*Vc1+(-4).*Rc3.*sig3.*( ...
  (-1)+(-1).*sig1.^2+sig2.^2+sig3.^2).*Vc2+(-2).*(sig1.^3+(-1).* ...
  sig1.^2.*sig2.*sig3+sig1.*(1+sig2.^2+(-3).*sig3.^2)+(-1).*sig2.* ...
  sig3.*((-3)+sig2.^2+sig3.^2)).*(Rc2.*Vc1+(-1).*Rc1.*Vc2)+(4.*Rc2.* ...
  sig3.*((-1)+(-1).*sig1.^2+sig2.^2+sig3.^2)+Rc1.*((-1)+(sig1.^2+ ...
  sig2.^2).^2+8.*sig1.*sig2.*sig3+6.*sig3.^2+(-1).*sig3.^4)).*Vc3).* ...
  ((Rc2.*Vc1+(-1).*Rc1.*Vc2).^2+(Rc3.*Vc1+(-1).*Rc1.*Vc3).^2+(Rc3.* ...
  Vc2+(-1).*Rc2.*Vc3).^2).^(-1/2);4.*(1+sig1.^2+sig2.^2+sig3.^2).^( ...
  -3).*(4.*Rc3.*sig1.*((-1)+sig1.^2+(-1).*sig2.^2+sig3.^2).*Vc1+ ...
  Rc2.*((-6).*sig1.^2+sig1.^4+8.*sig1.*sig2.*sig3+(-1).*((-1)+ ...
  sig2.^2+sig3.^2).*(1+sig2.^2+sig3.^2)).*Vc1+(-2).*Rc3.*(sig2+(-3) ...
  .*sig1.^2.*sig2+sig2.^3+(-1).*sig1.*((-3)+sig1.^2+sig2.^2).*sig3+ ...
  sig2.*sig3.^2+(-1).*sig1.*sig3.^3).*Vc2+Rc1.*((-1)+6.*sig1.^2+(-1) ...
  .*sig1.^4+(-8).*sig1.*sig2.*sig3+(sig2.^2+sig3.^2).^2).*Vc2+(-4).* ...
  Rc1.*sig1.*((-1)+sig1.^2+(-1).*sig2.^2+sig3.^2).*Vc3+2.*Rc2.*( ...
  sig2+(-3).*sig1.^2.*sig2+sig2.^3+(-1).*sig1.*((-3)+sig1.^2+ ...
  sig2.^2).*sig3+sig2.*sig3.^2+(-1).*sig1.*sig3.^3).*Vc3).*((Rc2.* ...
  Vc1+(-1).*Rc1.*Vc2).^2+(Rc3.*Vc1+(-1).*Rc1.*Vc3).^2+(Rc3.*Vc2+(-1) ...
  .*Rc2.*Vc3).^2).^(-1/2),8.*(1+sig1.^2+sig2.^2+sig3.^2).^(-3).*(4.* ...
  Rc3.*sig2.*(sig1.^2+sig3.^2).*Vc1+Rc2.*(sig1.^3.*sig2+(-1).* ...
  sig1.^2.*sig3+(-1).*sig3.*(1+(-3).*sig2.^2+sig3.^2)+sig1.*sig2.*(( ...
  -3)+sig2.^2+sig3.^2)).*Vc1+(-1).*Rc3.*(sig1+sig1.^3+(-3).*sig1.* ...
  sig2.^2+(-1).*sig2.*((-3)+sig1.^2+sig2.^2).*sig3+sig1.*sig3.^2+( ...
  -1).*sig2.*sig3.^3).*Vc2+Rc1.*((-1).*sig1.^3.*sig2+sig3+sig1.^2.* ...
  sig3+(-3).*sig2.^2.*sig3+sig3.^3+(-1).*sig1.*sig2.*((-3)+sig2.^2+ ...
  sig3.^2)).*Vc2+(-4).*Rc1.*sig2.*(sig1.^2+sig3.^2).*Vc3+Rc2.*(sig1+ ...
  sig1.^3+(-3).*sig1.*sig2.^2+(-1).*sig2.*((-3)+sig1.^2+sig2.^2).* ...
  sig3+sig1.*sig3.^2+(-1).*sig2.*sig3.^3).*Vc3).*((Rc2.*Vc1+(-1).* ...
  Rc1.*Vc2).^2+(Rc3.*Vc1+(-1).*Rc1.*Vc3).^2+(Rc3.*Vc2+(-1).*Rc2.* ...
  Vc3).^2).^(-1/2),4.*(1+sig1.^2+sig2.^2+sig3.^2).^(-3).*(4.*Rc3.* ...
  sig3.*((-1)+sig1.^2+(-1).*sig2.^2+sig3.^2).*Vc1+(-2).*Rc2.*( ...
  sig2.^3+(-1).*sig1.*sig2.^2.*sig3+sig2.*(1+sig1.^2+(-3).*sig3.^2)+ ...
  (-1).*sig1.*sig3.*((-3)+sig1.^2+sig3.^2)).*Vc1+2.*Rc1.*(sig2.*(1+ ...
  sig1.^2+sig2.^2)+(-1).*sig1.*((-3)+sig1.^2+sig2.^2).*sig3+(-3).* ...
  sig2.*sig3.^2+(-1).*sig1.*sig3.^3).*Vc2+(-1).*Rc3.*((-1)+(sig1.^2+ ...
  sig2.^2).^2+(-8).*sig1.*sig2.*sig3+6.*sig3.^2+(-1).*sig3.^4).*Vc2+ ...
  (-4).*Rc1.*sig3.*((-1)+sig1.^2+(-1).*sig2.^2+sig3.^2).*Vc3+Rc2.*(( ...
  -1)+(sig1.^2+sig2.^2).^2+(-8).*sig1.*sig2.*sig3+6.*sig3.^2+(-1).* ...
  sig3.^4).*Vc3).*((Rc2.*Vc1+(-1).*Rc1.*Vc2).^2+(Rc3.*Vc1+(-1).* ...
  Rc1.*Vc3).^2+(Rc3.*Vc2+(-1).*Rc2.*Vc3).^2).^(-1/2);4.*(1+sig1.^2+ ...
  sig2.^2+sig3.^2).^(-3).*(Rc3.*((-1)+6.*sig1.^2+(-1).*sig1.^4+(-8) ...
  .*sig1.*sig2.*sig3+(sig2.^2+sig3.^2).^2).*Vc1+(-2).*Rc3.*( ...
  sig1.^3.*sig2+(-3).*sig1.^2.*sig3+sig1.*sig2.*((-3)+sig2.^2+ ...
  sig3.^2)+sig3.*(1+sig2.^2+sig3.^2)).*Vc2+(-4).*sig1.*((-1)+ ...
  sig1.^2+sig2.^2+(-1).*sig3.^2).*(Rc2.*Vc1+(-1).*Rc1.*Vc2)+2.*Rc2.* ...
  (sig1.^3.*sig2+(-3).*sig1.^2.*sig3+sig1.*sig2.*((-3)+sig2.^2+ ...
  sig3.^2)+sig3.*(1+sig2.^2+sig3.^2)).*Vc3+Rc1.*((-6).*sig1.^2+ ...
  sig1.^4+8.*sig1.*sig2.*sig3+(-1).*((-1)+sig2.^2+sig3.^2).*(1+ ...
  sig2.^2+sig3.^2)).*Vc3).*((Rc2.*Vc1+(-1).*Rc1.*Vc2).^2+(Rc3.*Vc1+( ...
  -1).*Rc1.*Vc3).^2+(Rc3.*Vc2+(-1).*Rc2.*Vc3).^2).^(-1/2),4.*(1+ ...
  sig1.^2+sig2.^2+sig3.^2).^(-3).*((-4).*Rc2.*sig2.*((-1)+sig1.^2+ ...
  sig2.^2+(-1).*sig3.^2).*Vc1+2.*Rc3.*((-1).*sig1.^3.*sig2+sig3+ ...
  sig1.^2.*sig3+(-3).*sig2.^2.*sig3+sig3.^3+(-1).*sig1.*sig2.*((-3)+ ...
  sig2.^2+sig3.^2)).*Vc1+4.*Rc1.*sig2.*((-1)+sig1.^2+sig2.^2+(-1).* ...
  sig3.^2).*Vc2+Rc3.*((-1)+sig1.^4+6.*sig2.^2+(-1).*sig2.^4+8.* ...
  sig1.*sig2.*sig3+2.*sig1.^2.*sig3.^2+sig3.^4).*Vc2+(-1).*Rc2.*(( ...
  -1)+sig1.^4+6.*sig2.^2+(-1).*sig2.^4+8.*sig1.*sig2.*sig3+2.* ...
  sig1.^2.*sig3.^2+sig3.^4).*Vc3+2.*Rc1.*(sig1.^3.*sig2+(-1).* ...
  sig1.^2.*sig3+(-1).*sig3.*(1+(-3).*sig2.^2+sig3.^2)+sig1.*sig2.*(( ...
  -3)+sig2.^2+sig3.^2)).*Vc3).*((Rc2.*Vc1+(-1).*Rc1.*Vc2).^2+(Rc3.* ...
  Vc1+(-1).*Rc1.*Vc3).^2+(Rc3.*Vc2+(-1).*Rc2.*Vc3).^2).^(-1/2),8.*( ...
  1+sig1.^2+sig2.^2+sig3.^2).^(-3).*(Rc3.*(sig2.^3+(-1).*sig1.* ...
  sig2.^2.*sig3+sig2.*(1+sig1.^2+(-3).*sig3.^2)+(-1).*sig1.*sig3.*(( ...
  -3)+sig1.^2+sig3.^2)).*Vc1+(-1).*Rc3.*(sig1.^3+sig1.^2.*sig2.* ...
  sig3+sig1.*(1+sig2.^2+(-3).*sig3.^2)+sig2.*sig3.*((-3)+sig2.^2+ ...
  sig3.^2)).*Vc2+(-4).*(sig1.^2+sig2.^2).*sig3.*(Rc2.*Vc1+(-1).* ...
  Rc1.*Vc2)+((Rc2.*sig1+(-1).*Rc1.*sig2).*(1+sig1.^2+sig2.^2)+(Rc1.* ...
  sig1+Rc2.*sig2).*((-3)+sig1.^2+sig2.^2).*sig3+3.*((-1).*Rc2.*sig1+ ...
  Rc1.*sig2).*sig3.^2+(Rc1.*sig1+Rc2.*sig2).*sig3.^3).*Vc3).*((Rc2.* ...
  Vc1+(-1).*Rc1.*Vc2).^2+(Rc3.*Vc1+(-1).*Rc1.*Vc3).^2+(Rc3.*Vc2+(-1) ...
  .*Rc2.*Vc3).^2).^(-1/2)];

pCb3pXstate = [pCb3pSigma, zeros(3,9)];

% ---------------------------------------------------------------------------

pn3vec1pSigma=[8.*(1+sig1.^2+sig2.^2+sig3.^2).^(-3).*((-4).*sig1.*(sig2+sig1.* ...
  sig3)+(sig1.*sig2+sig3).*(1+sig1.^2+sig2.^2+sig3.^2)),(-4).*(1+ ...
  sig1.^2+sig2.^2+sig3.^2).^(-3).*((-1)+sig1.^4+6.*sig2.^2+(-1).* ...
  sig2.^4+8.*sig1.*sig2.*sig3+2.*sig1.^2.*sig3.^2+sig3.^4),8.*(1+ ...
  sig1.^2+sig2.^2+sig3.^2).^(-3).*(sig1.^3+sig1.^2.*sig2.*sig3+ ...
  sig1.*(1+sig2.^2+(-3).*sig3.^2)+sig2.*sig3.*((-3)+sig2.^2+sig3.^2) ...
  )];

pn3vec2pSigma=[4.*(1+sig1.^2+sig2.^2+sig3.^2).^(-3).*((-1)+6.*sig1.^2+(-1).* ...
  sig1.^4+(-8).*sig1.*sig2.*sig3+(sig2.^2+sig3.^2).^2),8.*(1+ ...
  sig1.^2+sig2.^2+sig3.^2).^(-3).*((-1).*sig1.^3.*sig2+sig3+ ...
  sig1.^2.*sig3+(-3).*sig2.^2.*sig3+sig3.^3+(-1).*sig1.*sig2.*((-3)+ ...
  sig2.^2+sig3.^2)),8.*(1+sig1.^2+sig2.^2+sig3.^2).^(-3).*(sig2.^3+( ...
  -1).*sig1.*sig2.^2.*sig3+sig2.*(1+sig1.^2+(-3).*sig3.^2)+(-1).* ...
  sig1.*sig3.*((-3)+sig1.^2+sig3.^2))];

pn3vec3pSigma=[16.*sig1.*((-1)+sig1.^2+sig2.^2+(-1).*sig3.^2).*(1+sig1.^2+ ...
  sig2.^2+sig3.^2).^(-3),16.*sig2.*((-1)+sig1.^2+sig2.^2+(-1).* ...
  sig3.^2).*(1+sig1.^2+sig2.^2+sig3.^2).^(-3),32.*(sig1.^2+sig2.^2) ...
  .*sig3.*(1+sig1.^2+sig2.^2+sig3.^2).^(-3)];


dotTerm = (n3Vec'*rSunDeputy);
DrSunDeputyDrho = -eye(3)/norm(rSun - rDeputy) ...
                    + (rSun - rDeputy)*(rSun - rDeputy)'/norm(rSun - rDeputy)^3;
DAccDrho = 2*PD*dotTerm/norm(rSun - rDeputy)^4*...
    (C1*rSunDeputy + (C2*dotTerm + C3)*n3Vec)*(rSun - rDeputy)'...
    + PD/norm(rSun - rDeputy)^2*( (C1*rSunDeputy + (C2*dotTerm + C3)*n3Vec)*n3Vec'...
    + dotTerm*(C1*eye(3) + C2*n3Vec*n3Vec') )*DrSunDeputyDrho;

Dn3VecDsigma = [pn3vec1pSigma;pn3vec2pSigma;pn3vec3pSigma];
DAccDsigma = PD/norm(rSun - rDeputy)^2*((C1*rSunDeputy + (C2*dotTerm + C3)*n3Vec)*rSunDeputy'...
    + dotTerm*((C2*dotTerm + C3)*eye(3) + C2*n3Vec*rSunDeputy'))*Dn3VecDsigma;

% ------------------------------------------------------------------------
DAccDXstate = [DAccDsigma, zeros(3), DAccDrho, zeros(3)];
PartialDelAccsrp_PartialXstate = BMatrix*DAccDXstate + [Acc'*pCb1pXstate; Acc'*pCb2pXstate; Acc'*pCb3pXstate];


%% Partial of the relaive gravity froce on the deputy plate

pDelAccgprho = [(-1).*muEarth.*((Rc2+rho2).^2+(Rc3+rho3).^2).*((Rc1+ ...
  rho1).^2+(Rc2+rho2).^2+(Rc3+rho3).^2).^(-3/2),muEarth.*(Rc1+rho1) ...
  .*(Rc2+rho2).*((Rc1+rho1).^2+(Rc2+rho2).^2+(Rc3+rho3).^2).^(-3/2), ...
  muEarth.*(Rc1+rho1).*(Rc3+rho3).*((Rc1+rho1).^2+(Rc2+rho2).^2+( ...
  Rc3+rho3).^2).^(-3/2);muEarth.*(Rc1+rho1).*(Rc2+rho2).*((Rc1+rho1) ...
  .^2+(Rc2+rho2).^2+(Rc3+rho3).^2).^(-3/2),(-1).*muEarth.*((Rc1+ ...
  rho1).^2+(Rc3+rho3).^2).*((Rc1+rho1).^2+(Rc2+rho2).^2+(Rc3+rho3) ...
  .^2).^(-3/2),muEarth.*(Rc2+rho2).*(Rc3+rho3).*((Rc1+rho1).^2+(Rc2+ ...
  rho2).^2+(Rc3+rho3).^2).^(-3/2);muEarth.*(Rc1+rho1).*(Rc3+rho3).*( ...
  (Rc1+rho1).^2+(Rc2+rho2).^2+(Rc3+rho3).^2).^(-3/2),muEarth.*(Rc2+ ...
  rho2).*(Rc3+rho3).*((Rc1+rho1).^2+(Rc2+rho2).^2+(Rc3+rho3).^2).^( ...
  -3/2),(-1).*muEarth.*((Rc1+rho1).^2+(Rc2+rho2).^2).*((Rc1+rho1) ...
  .^2+(Rc2+rho2).^2+(Rc3+rho3).^2).^(-3/2)];
PartialDelGrav_PartialXstate = [zeros(3,6), pDelAccgprho, zeros(3)];


%% Partial of the coriolis effect on the deputy plate

pDelCoriolisprhorhodot=[omegaCh2.^2+omegaCh3.^2,(-1).*omegaCh1.*omegaCh2+omegaCh3,(-1).* ...
  omegaCh2+(-1).*omegaCh1.*omegaCh3,0,2.*omegaChdot3,(-2).* ...
  omegaChdot2;(-1).*omegaCh1.*omegaCh2+(-1).*omegaCh3,omegaCh1.^2+ ...
  omegaCh3.^2,omegaCh1+(-1).*omegaCh2.*omegaCh3,(-2).*omegaChdot3,0, ...
  2.*omegaChdot1;omegaCh2+(-1).*omegaCh1.*omegaCh3,(-1).*omegaCh1+( ...
  -1).*omegaCh2.*omegaCh3,omegaCh1.^2+omegaCh2.^2,2.*omegaChdot2,( ...
  -2).*omegaChdot1,0];
PartialDelCoriolis_PartialXstate = [zeros(3,6), pDelCoriolisprhorhodot];


%% Partial of the accelerations on the deputy plate

PartialRelAcceleration  = PartialDelGrav_PartialXstate + PartialDelAccsrp_PartialXstate + PartialDelCoriolis_PartialXstate;


%% Partial of the relative velocity of the deputy plate

PartialRelVelocity = [zeros(3,6), eye(3), zeros(3)];

%% Partial of angular velocity

PartialAngularVel=[0,0,0,0,i1.^(-1).*(i2+(-1).*i3).*omg3,i1.^(-1).*(i2+(-1).*i3).* ...
  omg2;0,0,0,i2.^(-1).*((-1).*i1+i3).*omg3,0,i2.^(-1).*((-1).*i1+i3) ...
  .*omg1;0,0,0,(i1+(-1).*i2).*i3.^(-1).*omg2,(i1+(-1).*i2).*i3.^(-1) ...
  .*omg1,0];
PartialAngularVel = [PartialAngularVel, zeros(3,6)];

%% Partial of MRPs

PartialMRPs=[(1/2).*(omg1.*sig1+omg2.*sig2+omg3.*sig3),(1/2).*(omg3+omg2.* ...
  sig1+(-1).*omg1.*sig2),(1/2).*((-1).*omg2+omg3.*sig1+(-1).*omg1.* ...
  sig3),(1/4).*(1+sig1.^2+(-1).*sig2.^2+(-1).*sig3.^2),(1/2).*( ...
  sig1.*sig2+(-1).*sig3),(1/2).*(sig2+sig1.*sig3);(1/2).*((-1).* ...
  omg3+(-1).*omg2.*sig1+omg1.*sig2),(1/2).*(omg1.*sig1+omg2.*sig2+ ...
  omg3.*sig3),(1/2).*(omg1+omg3.*sig2+(-1).*omg2.*sig3),(1/2).*( ...
  sig1.*sig2+sig3),(1/4).*(1+(-1).*sig1.^2+sig2.^2+(-1).*sig3.^2),( ...
  1/2).*((-1).*sig1+sig2.*sig3);(1/2).*(omg2+(-1).*omg3.*sig1+omg1.* ...
  sig3),(1/2).*((-1).*omg1+(-1).*omg3.*sig2+omg2.*sig3),(1/2).*( ...
  omg1.*sig1+omg2.*sig2+omg3.*sig3),(1/2).*((-1).*sig2+sig1.*sig3),( ...
  1/2).*(sig1+sig2.*sig3),(1/4).*(1+(-1).*sig1.^2+(-1).*sig2.^2+ ...
  sig3.^2)];

PartialMRPs = [PartialMRPs, zeros(3,6)];

%% Partial of Fd with respect to the state vector

PartialFd = [PartialMRPs; PartialAngularVel; PartialRelVelocity; PartialRelAcceleration];














